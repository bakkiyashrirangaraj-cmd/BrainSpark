# BrainSpark Pull Request Checks
name: PR Check

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint-backend:
    name: Lint Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          pip install ruff black isort

      - name: Run ruff
        run: |
          cd backend
          ruff check . || echo "Ruff check pending configuration"

      - name: Check formatting with black
        run: |
          cd backend
          black --check . || echo "Black check pending configuration"

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint || echo "ESLint pending configuration"

      - name: Check TypeScript
        run: |
          cd frontend
          npx tsc --noEmit || echo "TypeScript check pending"

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build backend Docker image
        run: |
          docker build -t brainspark-api:pr ./backend

      - name: Build frontend Docker image
        run: |
          docker build \
            --build-arg VITE_API_URL=https://api.brainspark.siggmatreders.com \
            -t brainspark-web:pr ./frontend

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6'

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive || echo "Format check pending"

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [lint-backend, lint-frontend, build-check, terraform-validate]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## PR Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Lint | ${{ needs.lint-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lint | ${{ needs.lint-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | ${{ needs.build-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform-validate.result }} |" >> $GITHUB_STEP_SUMMARY
